<!DOCTYPE html>
<html lang=en>
 <head>
  <meta charset=UTF-8>
  <link rel=stylesheet
        href=https://unpkg.com/tachyons/css/tachyons.min.css>
  <style>code {
                  background-color: gray;
                  color: white;
                  }</style>
  <meta name=viewport
        content="width=device-width, initial-scale=1.0">
  <title>Install arbitrary node versions on Docker container via nvm</title>
 </head>
 <body class="athelas pa3 pa5-l pa5-m">
  <header>
   <h1><a class="link dim black b db mb3 mb4-ns" href=../index.html title=M2AS>M2AS</a></h1>
  </header>
  <article class="cf pt3">
   <header class="fn fl-l w-50-l pr4-l pb4">
    <h1
        class="f2 lh-title fw9 mb3 mt0 pt3 bt bw2">Install arbitrary node versions on 
     Docker container via nvm</h1>
    <h2 class="f3 mid-gray lh-title"></h2>
    <time class="f3 ttu tracked gray">2016-10-21</time>
   </header>
   <div class="fn fl-l w-50-l bt bw1 bn-l">
    <div class="f4 lh-copy measure"><p>We've been using Docker to run our Node tests and encapsulate odd depencencies for a while now,  and it's worked out pretty well. We have a "baked-in" Node version via an official Node build, and add a couple of Docker layers on top for our needs. However, we're in the middle of upgrading to Node 6, and we're running into snags upgrading packages and extricating the mountain of Babel dependencies from our codebase (we'll survive with ES6 for now). What this means is we're flipping between Node versions and we need to have a way to run CI tests on Docker on an arbitrary Node version. </p><p>One way of solving this problem is having different Docker images for the versions you're targeting and configure the CI (Teamcity in this case) to watch for specific git branches, then use the appropriate Docker image. Another, hackier but more flexible solution is to select and use a Node version at <code>docker run</code>-time based on a <code>.nvmrc</code> file. </p><p>"But wait!", I hear you say. Doesn't that mean that you'll have an external dependency and you'll install Node every time you run your tests?! I would look off into the horizon, and say, Sometimes we need to push the agenda forward. Sometimes we must do non-kosher, hacky things to keep the builds going. Especially when you have limited server control and build configs. </p><p>The purpose of this post is not to defend the choice of installing Node every time we do <code>docker run</code> (its indefensible) nor to advocate that you should (you really shouldn't), but rather to show a way of running arbitrary Node versions on a Docker container, should you choose to do so. It's actually not complicated - though there is some <code>ENV</code> juggling necessary, due to the nature of nvm. </p><p>Of interest are really these two parts: </p><p><code></code><code> RUN rm /bin/sh &amp;&amp; ln -s /bin/bash /bin/sh #... CMD source Â±/.nvm/nvm.sh &amp;&amp; cd /usr/src/app &amp;&amp; nvm install &amp;&amp; npm i &amp;&amp; npm test </code><code></code> </p><p>The first subs <code>sh</code> for <code>bash</code>, allowing us to <code>source</code> files for running subsequent commands. The second activates <code>nvm</code> and installs a given node version, followed by any node commands needed. </p><p>This is <em>not</em> supposed to be a permanent or prod solution, but it gets the job done. Fun to do, but it's going out as soon as we're done with our upgrades! </p>
    </div>
   </div>
  </article>
  <footer class="pv4 ph3 ph5-m ph6-l mid-gray">
   <span class="f3 db tc">(C) AD 2023</span>
  </footer>
 </body>
</html>